## Other customisations

The following section demonstrates some common customisations made to `{ggplot2}` charts. Each example builds on the previous one.

Note that `theme_sg()` has arguments to control the legend position and appearance of grid lines, axis lines and axis ticks. More information on accepted values can be found in the [help file](../reference/theme_sg.html).

Customisations will be made to the following basic horizontal bar chart:

```{r before-customisation}
#| fig.alt = "A horizontal bar chart using sgplot theme and dark blue colour."

bar_data |>
  ggplot(aes(x = pop, y = country)) +
  geom_col(fill = sg_colour_values["dark-blue"]) +
  theme_sg(axis = "y", grid = "x")
```


### Sorting a bar chart

To control the order of bars in a chart, wrap the variable you want to arrange with `reorder()` and specify what variable you want to sort by. The following example sorts bars in ascending order of life expectancy. To sort in descending order, you would change this to `reorder(country, desc(lifeExp))`.

```{r sorting}
#| fig.alt = "A horizontal bar chart using sgplot theme and dark blue colour with bars sorted in decreasing order by population."

bar_data |>
  ggplot(aes(x = pop, y = reorder(country, pop))) +
  geom_col(fill = sg_colour_values["dark-blue"]) +
  theme_sg(axis = "y", grid = "x")
```


### Changing chart titles and wrapping text

Chart titles such as the main title, subtitle, caption, axis titles and legend titles, can be controlled using `labs()`. A title can be removed using `NULL`.

Remember that it is [best practice to provide chart titles and subtitles in the main body of text](https://analysisfunction.civilservice.gov.uk/policy-store/data-visualisation-charts/#section-5), rather than embedded in the chart. 

```{r chart-titles}
#| fig.alt = "A bar chart with title, subtitle and caption. The axis titles have been removed. The main title is too long and the end is cut off."

last_plot() +
  labs(
    x = NULL,
    y = NULL,
    title = "The United States is the most populous country in the Americas",
    subtitle = "Population of countries in the Americas (millions), 2007",
    caption = "Source: Gapminder"
  )
```

If text is too long, it may be cut off or distort the dimensions of the chart. There are two suggested ways to solve this issue.

Insert `\n` within a string to force a line break:

```{r text-wrap-1}
#| fig.alt = "A bar chart with main title and y-axis title text wrapped onto two lines."

last_plot() +
  labs(
    title = "The United States is the most populous country \nin the Americas"
  )
```

Use `stringr::str_wrap()` to set a maximum character width of the string:

```{r text-wrap-2}
#| fig.alt = "A bar chart with main title and y-axis title text wrapped onto two lines."

last_plot() +
  labs(
    title = stringr::str_wrap(
      "The United States is the most populous country in the Americas",
      width = 50
    )
  )
```


### Reducing space between chart and axis

By default, a bar chart will have a gap between the bottom of the bars and the axis. This can be removed as follows:

```{r expand}
#| fig.alt = "A bar chart with no space between bottom of bars and x-axis."

last_plot() + 
  scale_x_continuous(expand = c(0, 0))
```

The equivalent adjustment can be made for the y-axis using `scale_y_continuous`.


### Changing axis limits, breaks and labels

Axis limits, breaks and labels for continuous variables can be controlled using `scale_x/y_continuous()`. For discrete variables, labels can be changed using `scale_x/y_discrete()` or alternatively by recoding the variable in the data before creating a chart.

Note that further calls to `scale_x/y_continuous` will overwrite previous calls, hence why `expand = c(0, 0)` has been included again in these examples.

```{r axis-limits-breaks-labels}
#| fig.alt = "A bar chart with more x-axis breaks and formatted labels. The last label is suffixed with 'million'."

last_plot() +
  scale_x_continuous(expand = c(0, 0),
                     limits = c(0, 3e8 * 1.1),
                     breaks = seq(0, 3e8, 5e7),
                     labels = c(seq(0, 250, 50), "300 million"))
```

Labels can also be formatted using a function. The `{scales}` package provides many convenient functions for this, and can handle percentages, currency and thousands separators. 

```{r scales-pkg}
#| fig.alt = "A bar chart with fewer x-axis breaks and labels formatted with comma thousands separators."

last_plot() +
  scale_x_continuous(expand = c(0, 0),
                     limits = c(0, 3e8 * 1.1),
                     breaks = seq(0, 3e8, 1e8),
                     labels = scales::label_comma())
```


### Adjusting theme elements

If you find you need to adjust theme elements for your chart, this can be done using `theme()`. Note that this should be done after the call to `theme_sg()`, otherwise `theme_sg()` may overwrite the specifications you've made.

```{r adjust-theme}
#| fig.alt = "A bar chart using sgplot theme and dark blue colour, with y-axis lines and ticks coloured black."

last_plot() +
  theme(axis.line.y = element_line(colour = "black"),
        axis.ticks.y = element_line(colour = "black"))
```


### Avoiding axis/grid lines being cut off

Axis lines and grid lines can sometimes appear 'cut off' if they are drawn at the limits of the chart range. You can see in the following example that the top grid line is slightly narrower than the adjacent tick mark on the y-axis. This is because the y-axis limit is 100%. As the grid line is centred at 100%, the top half of the line is 'cut off'.

```{r clip-1, fig.height = 5.5}
#| fig.alt = "A stacked bar chart with top gridline is half the width of the adjoining tick mark and other grid lines."

stacked_bar_data |>
  ggplot(aes(x = continent, y = n_countries, fill = lifeExpGrouped)) +
  geom_bar(stat = "identity", position = "fill") +
  theme_sg(legend = "bottom") +
  scale_y_continuous(expand = c(0, 0), labels = scales::percent) +
  scale_fill_discrete_sg() +
  labs(
    x = NULL,
    y = NULL,
    fill = "Life Expectancy",
    title = "How life expectancy varies across continents",
    subtitle = "Percentage of countries by life expectancy band, 2007",
    caption = "Source: Gapminder"
  )
```

This can be corrected as follows:

```{r clip-2, fig.height = 5.5}
#| fig.alt = "A stacked bar chart with top gridline the same width as adjoining tick mark and other grid lines."

last_plot() + 
  coord_cartesian(clip = "off")
```


### Adding a reference line

To add a horizontal or vertical line across the whole plot, use `geom_hline()` or `geom_vline()`. This can be useful to highlight a threshold or average level.

```{r add-a-line}
#| fig.alt = "A line chart with dashed, grey horizontal line at age 75."

gapminder |>
  filter(country == "United Kingdom") |>
  ggplot(aes(x = year, y = lifeExp)) +
  geom_hline(yintercept = 75, 
             colour = sg_colour_values["grey"],
             linewidth = 1, 
             linetype = "longdash") +
  geom_line(linewidth = 1, 
            colour = sg_colour_values["dark-blue"]) +
  annotate(geom = "text", x = 2007, y = 70, label = "Age 70") +
  theme_sg() +
  scale_y_continuous(limits = c(0, 82),
                     breaks = seq(0, 80, 20),
                     expand = c(0, 0)) +
  scale_x_continuous(breaks = seq(1952, 2007, 5)) +
  labs(
    x = "Year",
    y = NULL,
    title = "Living Longer",
    subtitle = "Life Expectancy in the United Kingdom 1952-2007",
    caption = "Source: Gapminder"
  )
```

